name: PR Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  pr-tests:
    name: PR Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # ============================================
      # SECURITY CHECKS
      # ============================================
      - name: Security - Environment file protection
        run: |
          echo "üîí Checking environment file security..."
          
          # Check .env is not tracked
          if git ls-files | grep -q "^\.env$"; then
            echo "‚ùå CRITICAL: .env file is tracked in git!"
            exit 1
          fi
          
          # Check .env is in .gitignore
          if ! grep -qE "^\.env$|^\.env\." .gitignore; then
            echo "‚ùå .env not in .gitignore"
            exit 1
          fi
          
          # Check .env.example exists
          if [ ! -f .env.example ]; then
            echo "‚ùå .env.example is missing"
            exit 1
          fi
          
          echo "‚úÖ Environment files properly secured"
      
      - name: Security - Hardcoded secrets scan
        run: |
          echo "üîç Scanning for hardcoded secrets..."
          
          # Check for Firebase API keys (should only be placeholders)
          if grep -rE "AIzaSy[A-Za-z0-9_-]{20,}" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_FIREBASE_API_KEY" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md" | grep -v "README.md"; then
            echo "‚ùå ERROR: Hardcoded Firebase API key found!"
            exit 1
          fi
          
          # Check for GitHub tokens (should only be placeholders)
          if grep -rE "ghp_[A-Za-z0-9]{20,}|gho_[A-Za-z0-9]{20,}|ghu_[A-Za-z0-9]{20,}|ghs_[A-Za-z0-9]{20,}|ghr_[A-Za-z0-9]{20,}" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_GITHUB_TOKEN" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md" | grep -v "README.md"; then
            echo "‚ùå ERROR: Hardcoded GitHub token found!"
            exit 1
          fi
          
          # Verify placeholders exist in source files
          if ! grep -q "VITE_FIREBASE_API_KEY" firebase-config.js; then
            echo "‚ùå firebase-config.js missing VITE_FIREBASE_API_KEY placeholder"
            exit 1
          fi
          
          if [ -f js/github-api.js ] && ! grep -q "VITE_GITHUB_TOKEN" js/github-api.js; then
            echo "‚ùå js/github-api.js missing VITE_GITHUB_TOKEN placeholder"
            exit 1
          fi
          
          # Check .env.example doesn't contain real secrets
          if grep -qE "AIzaSy[A-Za-z0-9_-]{20,}" .env.example; then
            echo "‚ùå .env.example contains real Firebase API key!"
            exit 1
          fi
          
          if grep -qE "ghp_[A-Za-z0-9]{20,}" .env.example; then
            echo "‚ùå .env.example contains real GitHub token!"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets found"
          echo "‚úÖ All placeholders are in place"
      
      # ============================================
      # FILE STRUCTURE CHECKS
      # ============================================
      - name: Files - Required files check
        run: |
          echo "üìÅ Checking required files..."
          
          required_files=(
            "index.html"
            "firebase-config.js"
            "package.json"
            "netlify.toml"
            ".gitignore"
            ".env.example"
            "build.js"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "‚ùå Missing required files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi
          
          echo "‚úÖ All required files present"
      
      # ============================================
      # CONFIGURATION VALIDATION
      # ============================================
      - name: Config - Validate netlify.toml
        run: |
          echo "üîß Validating netlify.toml..."
          
          if [ ! -f netlify.toml ]; then
            echo "‚ùå netlify.toml is missing"
            exit 1
          fi
          
          if ! grep -q "\[build\]" netlify.toml; then
            echo "‚ùå [build] section missing in netlify.toml"
            exit 1
          fi
          
          if ! grep -q "deploy-preview" netlify.toml; then
            echo "‚ö†Ô∏è  Warning: deploy-preview context not found"
          fi
          
          echo "‚úÖ netlify.toml is valid"
      
      - name: Config - Validate package.json
        run: |
          echo "üîß Validating package.json..."
          
          if [ ! -f package.json ]; then
            echo "‚ùå package.json missing"
            exit 1
          fi
          
          if ! grep -q "\"build\"" package.json; then
            echo "‚ùå package.json missing build script"
            exit 1
          fi
          
          echo "‚úÖ package.json is valid"
      
      # ============================================
      # CODE QUALITY CHECKS
      # ============================================
      - name: Code Quality - JavaScript syntax
        run: |
          echo "üîç Checking JavaScript syntax..."
          
          shopt -s nullglob
          
          # Function to check if file is ES module
          is_es_module() {
            grep -q "^import\|^export" "$1" 2>/dev/null || grep -q "from ['\"]" "$1" 2>/dev/null
          }
          
          # Check JS files in js/ directory
          for file in js/*.js; do
            if [ -f "$file" ]; then
              if is_es_module "$file"; then
                # ES modules need package.json with type: module
                temp_dir=$(mktemp -d)
                echo '{"type": "module"}' > "$temp_dir/package.json"
                cp "$file" "$temp_dir/"
                file_basename=$(basename "$file")
                check_output=$(cd "$temp_dir" && node --check "$file_basename" 2>&1)
                check_exit=$?
                rm -rf "$temp_dir"
                
                if [ $check_exit -ne 0 ]; then
                  if echo "$check_output" | grep -q "Cannot find module\|ERR_MODULE_NOT_FOUND"; then
                    echo "‚úì $file (ES module - syntax OK)"
                  else
                    echo "‚ùå Syntax error in $file"
                    echo "$check_output"
                    exit 1
                  fi
                fi
              else
                # CommonJS files
                node --check "$file" 2>/dev/null || {
                  echo "‚ùå Syntax error in $file"
                  exit 1
                }
              fi
            fi
          done
          
          # Check firebase-config.js
          if [ -f firebase-config.js ]; then
            if is_es_module firebase-config.js; then
              temp_dir=$(mktemp -d)
              echo '{"type": "module"}' > "$temp_dir/package.json"
              cp firebase-config.js "$temp_dir/"
              check_output=$(cd "$temp_dir" && node --check firebase-config.js 2>&1)
              check_exit=$?
              rm -rf "$temp_dir"
              
              if [ $check_exit -ne 0 ]; then
                if echo "$check_output" | grep -q "Cannot find module\|ERR_MODULE_NOT_FOUND"; then
                  echo "‚úì firebase-config.js (ES module - syntax OK)"
                else
                  echo "‚ùå Syntax error in firebase-config.js"
                  echo "$check_output"
                  exit 1
                fi
              fi
            else
              node --check firebase-config.js 2>/dev/null || {
                echo "‚ùå Syntax error in firebase-config.js"
                exit 1
              }
            fi
          fi
          
          echo "‚úÖ All JavaScript files have valid syntax"
      
      - name: Code Quality - Console.log check
        run: |
          echo "üîç Checking for console.log statements..."
          
          console_logs=$(grep -r "console\.log" js/ --include="*.js" 2>/dev/null | grep -v "//" | grep -v "console.log('" | wc -l || echo "0")
          
          if [ "$console_logs" -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: Found $console_logs console.log statements"
            echo "Consider removing them or using the centralized error handler"
            grep -r "console\.log" js/ --include="*.js" 2>/dev/null | grep -v "//" | head -5
          else
            echo "‚úÖ No console.log statements found (or all are in comments)"
          fi
      
      # ============================================
      # BUILD TESTS
      # ============================================
      - name: Build - Test with mock environment
        run: |
          echo "üß™ Testing build script..."
          
          # Set mock environment variables
          export VITE_FIREBASE_API_KEY="test_api_key_12345"
          export VITE_FIREBASE_AUTH_DOMAIN="test.firebaseapp.com"
          export VITE_FIREBASE_PROJECT_ID="test-project"
          export VITE_FIREBASE_STORAGE_BUCKET="test.firebasestorage.app"
          export VITE_FIREBASE_MESSAGING_SENDER_ID="123456789"
          export VITE_FIREBASE_APP_ID="1:123456789:web:test123"
          export VITE_FIREBASE_MEASUREMENT_ID="G-TEST123"
          export VITE_GITHUB_TOKEN="test_token_12345"
          
          # Run build
          npm run build
          
          # Verify placeholders were replaced
          if grep -q "VITE_FIREBASE_API_KEY" firebase-config.js; then
            echo "‚ùå Build failed: Placeholders not replaced in firebase-config.js"
            exit 1
          fi
          
          # Check for placeholder in code assignment
          if grep -q "const GITHUB_TOKEN = 'VITE_GITHUB_TOKEN'" js/github-api.js 2>/dev/null; then
            echo "‚ùå Build failed: Placeholders not replaced in js/github-api.js"
            exit 1
          fi
          
          echo "‚úÖ Build script works correctly"
      
      - name: Build - Validate output
        run: |
          echo "üîç Validating build output..."
          
          if [ -f scripts/validate-build.js ]; then
            node scripts/validate-build.js || {
              echo "‚ö†Ô∏è  Build validation script failed (check output above)"
            }
          else
            echo "‚ÑπÔ∏è  Build validation script not found (optional)"
          fi
      
      # ============================================
      # HTML VALIDATION
      # ============================================
      - name: HTML - Basic structure check
        run: |
          echo "üîç Checking HTML structure..."
          
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "‚ö†Ô∏è  Warning: index.html may not be valid HTML"
          else
            echo "‚úÖ index.html structure looks good"
          fi
      
      # ============================================
      # TEST SUMMARY
      # ============================================
      - name: Test Summary
        if: always()
        run: |
          echo "## üß™ PR Test Results"
          echo ""
          echo "### ‚úÖ Security Checks"
          echo "- Environment file protection"
          echo "- Hardcoded secrets detection"
          echo ""
          echo "### ‚úÖ File Structure"
          echo "- Required files present"
          echo ""
          echo "### ‚úÖ Configuration"
          echo "- Netlify and package.json validation"
          echo ""
          echo "### ‚úÖ Code Quality"
          echo "- JavaScript syntax validation"
          echo "- Code structure checks"
          echo ""
          echo "### ‚úÖ Build Tests"
          echo "- Build script functionality"
          echo "- Environment variable injection"
          echo ""
          echo "**Status:** All automated tests completed"
          echo ""
          echo "**Next Steps:**"
          echo "1. Review test results above"
          echo "2. Netlify will create preview deployment automatically"
          echo "3. Test preview deployment manually"
          echo "4. Request review when ready"

