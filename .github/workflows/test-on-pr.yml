name: Test on Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  test:
    name: Run All Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Check .env.example exists
        run: |
          if [ ! -f .env.example ]; then
            echo "‚ùå .env.example is missing"
            exit 1
          fi
          echo "‚úÖ .env.example exists"
      
      - name: Verify .env is ignored
        run: |
          if git check-ignore .env 2>/dev/null; then
            echo "‚úÖ .env is properly ignored"
          else
            echo "‚ö†Ô∏è  Warning: .env might not be in .gitignore"
          fi
      
      - name: Check for hardcoded secrets
        run: |
          echo "üîç Checking for hardcoded secrets..."
          
          # Check for Firebase API keys (should only be placeholders)
          if grep -r "AIzaSy" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_FIREBASE_API_KEY" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md"; then
            echo "‚ùå ERROR: Hardcoded Firebase API key found!"
            echo "Files containing hardcoded Firebase keys:"
            grep -r "AIzaSy" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_FIREBASE_API_KEY" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md"
            exit 1
          fi
          
          # Check for GitHub tokens (should only be placeholders)
          if grep -r "ghp_" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_GITHUB_TOKEN" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md"; then
            echo "‚ùå ERROR: Hardcoded GitHub token found!"
            echo "Files containing hardcoded GitHub tokens:"
            grep -r "ghp_" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_GITHUB_TOKEN" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md"
            exit 1
          fi
          
          # Check for Firebase project IDs (should only be placeholders)
          if grep -r "vedamopensource007" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_FIREBASE_PROJECT_ID" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md" | grep -v "README.md"; then
            echo "‚ö†Ô∏è  WARNING: Firebase project ID found in code (should use environment variable)"
            grep -r "vedamopensource007" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_FIREBASE_PROJECT_ID" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md" | grep -v "README.md"
          fi
          
          # Check for Firebase app IDs (should only be placeholders)
          if grep -r "1097939608119" --include="*.js" --include="*.html" --exclude-dir=node_modules . | grep -v "VITE_FIREBASE_MESSAGING_SENDER_ID" | grep -v "VITE_FIREBASE_APP_ID" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md" | grep -v "README.md"; then
            echo "‚ö†Ô∏è  WARNING: Firebase app/sender ID found in code (should use environment variable)"
          fi
          
          # Check that placeholders exist in source files
          if ! grep -q "VITE_FIREBASE_API_KEY" firebase-config.js; then
            echo "‚ùå ERROR: firebase-config.js missing VITE_FIREBASE_API_KEY placeholder"
            exit 1
          fi
          
          if ! grep -q "VITE_GITHUB_TOKEN" js/github-api.js && ! grep -q "VITE_GITHUB_TOKEN" app.js; then
            echo "‚ùå ERROR: GitHub token files missing VITE_GITHUB_TOKEN placeholder"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets found"
          echo "‚úÖ All placeholders are in place"
      
      - name: Test build with mock environment
        run: |
          echo "üß™ Testing build script..."
          
          # Set mock environment variables
          export VITE_FIREBASE_API_KEY="test_api_key_12345"
          export VITE_FIREBASE_AUTH_DOMAIN="test.firebaseapp.com"
          export VITE_FIREBASE_PROJECT_ID="test-project"
          export VITE_FIREBASE_STORAGE_BUCKET="test.firebasestorage.app"
          export VITE_FIREBASE_MESSAGING_SENDER_ID="123456789"
          export VITE_FIREBASE_APP_ID="1:123456789:web:test123"
          export VITE_FIREBASE_MEASUREMENT_ID="G-TEST123"
          export VITE_GITHUB_TOKEN="test_token_12345"
          
          # Run build
          npm run build
          
          # Verify placeholders were replaced
          if grep -q "VITE_FIREBASE_API_KEY" firebase-config.js; then
            echo "‚ùå Build failed: Placeholders not replaced in firebase-config.js"
            exit 1
          fi
          
          # Check for placeholder in code assignment (not in comments or strings)
          if grep -q "const GITHUB_TOKEN = 'VITE_GITHUB_TOKEN'" js/github-api.js || grep -q "GITHUB_TOKEN = 'VITE_GITHUB_TOKEN'" js/github-api.js; then
            echo "‚ùå Build failed: Placeholders not replaced in js/github-api.js"
            exit 1
          fi
          
          if [ -f app.js ] && (grep -q "const GITHUB_TOKEN = 'VITE_GITHUB_TOKEN'" app.js || grep -q "GITHUB_TOKEN = 'VITE_GITHUB_TOKEN'" app.js); then
            echo "‚ùå Build failed: Placeholders not replaced in app.js"
            exit 1
          fi
          
          # Verify no test values remain
          if grep -q "test_api_key_12345" firebase-config.js || grep -q "test_token_12345" js/github-api.js; then
            echo "‚ö†Ô∏è  Warning: Test values found in built files (this is expected in CI)"
          fi
          
          echo "‚úÖ Build script works correctly"
      
      - name: Verify file structure
        run: |
          echo "üìÅ Checking file structure..."
          
          required_files=(
            "index.html"
            "firebase-config.js"
            "package.json"
            "netlify.toml"
            ".gitignore"
            ".env.example"
            "build.js"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "‚ùå Missing required files:"
            printf '  - %s\n' "${missing_files[@]}"
            exit 1
          fi
          
          echo "‚úÖ All required files present"
      
      - name: Validate netlify.toml
        run: |
          echo "üîß Validating netlify.toml..."
          
          if [ ! -f netlify.toml ]; then
            echo "‚ùå netlify.toml is missing"
            exit 1
          fi
          
          # Check for required sections
          if ! grep -q "\[build\]" netlify.toml; then
            echo "‚ùå [build] section missing in netlify.toml"
            exit 1
          fi
          
          if ! grep -q "deploy-preview" netlify.toml; then
            echo "‚ö†Ô∏è  Warning: deploy-preview context not found"
          fi
          
          echo "‚úÖ netlify.toml is valid"
      
      - name: Check JavaScript syntax
        run: |
          echo "üîç Checking JavaScript syntax..."
          
          # Enable nullglob to handle empty globs gracefully
          shopt -s nullglob
          
          # Check for basic syntax errors in JS files
          for file in js/*.js; do
            if [ -f "$file" ]; then
              node --check "$file" 2>/dev/null || {
                echo "‚ùå Syntax error in $file"
                exit 1
              }
            fi
          done
          
          # Check main config file
          if [ -f firebase-config.js ]; then
            node --check firebase-config.js 2>/dev/null || {
              echo "‚ùå Syntax error in firebase-config.js"
              exit 1
            }
          fi
          
          echo "‚úÖ All JavaScript files have valid syntax"
      
      - name: Check for console.log statements
        run: |
          echo "üîç Checking for console.log statements..."
          
          console_logs=$(grep -r "console\.log" js/ --include="*.js" 2>/dev/null | grep -v "//" | grep -v "console.log('" | wc -l || echo "0")
          
          if [ "$console_logs" -gt 0 ]; then
            echo "‚ö†Ô∏è  Warning: Found $console_logs console.log statements"
            echo "Consider removing them before production or using centralized error handler"
            grep -r "console\.log" js/ --include="*.js" 2>/dev/null | grep -v "//" | head -5
          else
            echo "‚úÖ No console.log statements found (or all are in comments)"
          fi
      
      - name: Validate build output
        run: |
          echo "üîç Validating build output..."
          
          if [ -f scripts/validate-build.js ]; then
            node scripts/validate-build.js || {
              echo "‚ö†Ô∏è  Build validation script failed (may be expected in CI)"
            }
          else
            echo "‚ÑπÔ∏è  Build validation script not found (optional)"
          fi
      
      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results Summary"
          echo ""
          echo "‚úÖ All automated tests completed"
          echo ""
          echo "**Next Steps:**"
          echo "1. Review the test results above"
          echo "2. Netlify will create a preview deployment automatically"
          echo "3. Check the preview URL in PR comments"
          echo "4. Test the preview deployment manually"
          echo ""
          echo "**Production Deployment:**"
          echo "- Will happen automatically after PR is merged to \`main\`"
          echo "- No manual approval needed for preview deployments"

