name: Comprehensive PR Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  comprehensive-tests:
    name: Run Comprehensive Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      # ============================================
      # SECURITY TESTS
      # ============================================
      - name: Security - Check .env not in git
        run: |
          if git ls-files | grep -q "^\.env$"; then
            echo "‚ùå CRITICAL: .env file is tracked in git!"
            exit 1
          fi
          echo "‚úÖ .env file is not tracked"
      
      - name: Security - Verify .gitignore
        run: |
          if ! grep -qE "^\.env$|^\.env\." .gitignore; then
            echo "‚ùå .env not in .gitignore"
            exit 1
          fi
          echo "‚úÖ .env properly ignored"
      
      - name: Security - Scan for hardcoded secrets
        run: |
          # Check all JS files for hardcoded secrets
          if grep -rE "AIzaSy[A-Za-z0-9_-]{20,}" --include="*.js" --exclude-dir=node_modules . | grep -v "VITE_FIREBASE_API_KEY" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md"; then
            echo "‚ùå Hardcoded Firebase API key found!"
            exit 1
          fi
          
          if grep -rE "ghp_[A-Za-z0-9]{20,}" --include="*.js" --exclude-dir=node_modules . | grep -v "VITE_GITHUB_TOKEN" | grep -v ".env.example" | grep -v "SETUP.md" | grep -v "CONTRIBUTING.md" | grep -v "TESTING.md"; then
            echo "‚ùå Hardcoded GitHub token found!"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets found"
      
      # ============================================
      # BUILD TESTS
      # ============================================
      - name: Build - Test with mock environment
        run: |
          export VITE_FIREBASE_API_KEY="test_key_12345"
          export VITE_FIREBASE_AUTH_DOMAIN="test.firebaseapp.com"
          export VITE_FIREBASE_PROJECT_ID="test_project"
          export VITE_FIREBASE_STORAGE_BUCKET="test.firebasestorage.app"
          export VITE_FIREBASE_MESSAGING_SENDER_ID="123456789"
          export VITE_FIREBASE_APP_ID="1:123456789:web:test"
          export VITE_FIREBASE_MEASUREMENT_ID="G-TEST"
          export VITE_GITHUB_TOKEN="test_token_12345"
          
          npm run build
          
          # Verify replacements
          if grep -q "VITE_FIREBASE_API_KEY" firebase-config.js; then
            echo "‚ùå Build failed: Placeholders not replaced"
            exit 1
          fi
          
          echo "‚úÖ Build successful"
      
      # ============================================
      # FILE STRUCTURE TESTS
      # ============================================
      - name: Files - Check required files exist
        run: |
          required=(
            "index.html"
            "firebase-config.js"
            "package.json"
            "netlify.toml"
            ".gitignore"
            ".env.example"
            "build.js"
          )
          
          for file in "${required[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing: $file"
              exit 1
            fi
          done
          
          echo "‚úÖ All required files present"
      
      - name: Files - Check for unnecessary files
        run: |
          if [ -f ".env" ] && git ls-files | grep -q "^\.env$"; then
            echo "‚ùå .env file should not be committed"
            exit 1
          fi
          
          if [ -d "node_modules" ] && git ls-files | grep -q "node_modules"; then
            echo "‚ö†Ô∏è  Warning: node_modules might be tracked"
          fi
          
          echo "‚úÖ No unnecessary files committed"
      
      # ============================================
      # CODE QUALITY TESTS
      # ============================================
      - name: Code Quality - JavaScript syntax
        run: |
          # Enable nullglob to handle empty globs gracefully
          shopt -s nullglob
          
          # Check JS files in js/ directory
          for file in js/*.js; do
            if [ -f "$file" ]; then
              node --check "$file" 2>/dev/null || {
                echo "‚ùå Syntax error in $file"
                exit 1
              }
            fi
          done
          
          # Check main config file
          if [ -f firebase-config.js ]; then
            node --check firebase-config.js 2>/dev/null || {
              echo "‚ùå Syntax error in firebase-config.js"
              exit 1
            }
          fi
          
          echo "‚úÖ All JavaScript files have valid syntax"
      
      - name: Code Quality - Check for console.log
        run: |
          console_logs=$(grep -r "console\.log" js/ --include="*.js" 2>/dev/null | grep -v "//" | wc -l || echo "0")
          
          if [ "$console_logs" -gt 0 ]; then
            echo "‚ö†Ô∏è  Found $console_logs console.log statements (consider removing)"
            grep -r "console\.log" js/ --include="*.js" | grep -v "//" | head -3
          else
            echo "‚úÖ No console.log statements"
          fi
      
      # ============================================
      # CONFIGURATION TESTS
      # ============================================
      - name: Config - Validate netlify.toml
        run: |
          if ! grep -q "\[build\]" netlify.toml; then
            echo "‚ùå netlify.toml missing [build] section"
            exit 1
          fi
          
          if ! grep -q "deploy-preview" netlify.toml; then
            echo "‚ö†Ô∏è  Warning: deploy-preview context not found"
          fi
          
          echo "‚úÖ netlify.toml is valid"
      
      - name: Config - Validate package.json
        run: |
          if ! grep -q "\"build\"" package.json; then
            echo "‚ùå package.json missing build script"
            exit 1
          fi
          
          echo "‚úÖ package.json is valid"
      
      - name: Config - Check .env.example format
        run: |
          if ! grep -q "VITE_FIREBASE_API_KEY" .env.example; then
            echo "‚ùå .env.example missing required variables"
            exit 1
          fi
          
          # Check for real secrets (should only have placeholders)
          if grep -qE "AIzaSy[A-Za-z0-9_-]{20,}" .env.example; then
            echo "‚ùå .env.example contains real Firebase API key!"
            exit 1
          fi
          
          if grep -qE "ghp_[A-Za-z0-9]{20,}" .env.example; then
            echo "‚ùå .env.example contains real GitHub token!"
            exit 1
          fi
          
          echo "‚úÖ .env.example is safe (only placeholders)"
      
      # ============================================
      # ENVIRONMENT VARIABLE TESTS
      # ============================================
      - name: Env Vars - Verify placeholders in source
        run: |
          # Check firebase-config.js
          if ! grep -q "VITE_FIREBASE_API_KEY" firebase-config.js; then
            echo "‚ùå firebase-config.js missing VITE_FIREBASE_API_KEY placeholder"
            exit 1
          fi
          
          # Check github-api.js
          if [ -f js/github-api.js ] && ! grep -q "VITE_GITHUB_TOKEN" js/github-api.js; then
            echo "‚ùå js/github-api.js missing VITE_GITHUB_TOKEN placeholder"
            exit 1
          fi
          
          # Check app.js
          if [ -f app.js ] && ! grep -q "VITE_GITHUB_TOKEN" app.js; then
            echo "‚ùå app.js missing VITE_GITHUB_TOKEN placeholder"
            exit 1
          fi
          
          echo "‚úÖ All environment variable placeholders present"
      
      # ============================================
      # HTML VALIDATION
      # ============================================
      - name: HTML - Basic structure check
        run: |
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "‚ö†Ô∏è  Warning: index.html may not be valid HTML"
          else
            echo "‚úÖ index.html structure looks good"
          fi
      
      # ============================================
      # DEPENDENCY TESTS
      # ============================================
      - name: Dependencies - Check package.json
        run: |
          if [ ! -f package.json ]; then
            echo "‚ùå package.json missing"
            exit 1
          fi
          
          # Check for required dependencies
          if ! grep -q "dotenv" package.json; then
            echo "‚ö†Ô∏è  Warning: dotenv not in package.json (required for build)"
          fi
          
          echo "‚úÖ Dependencies check passed"
      
      # ============================================
      # FINAL SUMMARY
      # ============================================
      - name: Test Summary
        if: always()
        run: |
          echo "## üß™ Comprehensive Test Results"
          echo ""
          echo "### ‚úÖ Security Tests"
          echo "- Environment file protection"
          echo "- Secret detection"
          echo "- Git ignore verification"
          echo ""
          echo "### ‚úÖ Build Tests"
          echo "- Build script functionality"
          echo "- Environment variable injection"
          echo "- Placeholder replacement"
          echo ""
          echo "### ‚úÖ Code Quality Tests"
          echo "- JavaScript syntax validation"
          echo "- Code structure checks"
          echo ""
          echo "### ‚úÖ Configuration Tests"
          echo "- Netlify configuration"
          echo "- Package configuration"
          echo "- Environment template"
          echo ""
          echo "**Status:** All automated tests completed"
          echo ""
          echo "**Next Steps:**"
          echo "1. Review test results above"
          echo "2. Netlify will create preview deployment"
          echo "3. Test preview deployment manually"
          echo "4. Request review when ready"

